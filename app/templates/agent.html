{% extends "base.html" %}

{% block title %}Logus: Prompt Engineering Tool{% endblock %}

{% block styles %}
<style>
    .CodeMirror {
        height: calc(100vh - 400px);
        border: 1px solid #ddd;
    }
    .cm-alignment-1 { background-color: rgba(255, 0, 0, 0.2); }
    .cm-alignment-2 { background-color: rgba(255, 165, 0, 0.2); }
    .cm-alignment-3 { background-color: rgba(255, 255, 0, 0.2); }
    .cm-alignment-4 { background-color: rgba(144, 238, 144, 0.2); }
    .cm-alignment-5 { background-color: rgba(0, 255, 0, 0.2); }
    .cm-fragment-instruction::before { content: "üìù"; }
    .cm-fragment-context::before { content: "üåç"; }
    .cm-fragment-example::before { content: "üí°"; }
    .cm-fragment-constraint::before { content: "üö´"; }

    /* Add styles for fragment icons */
    .fragment-icon {
        position: absolute;
        right: -24px;
        width: 20px;
        height: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .CodeMirror {
        margin-right: 24px; /* Make space for icons */
    }

    /* Fragment type indicators */
    .fragment-icon.instruction { background-color: rgba(255, 182, 193, 0.2); }
    .fragment-icon.context { background-color: rgba(173, 216, 230, 0.2); }
    .fragment-icon.example { background-color: rgba(144, 238, 144, 0.2); }
    .fragment-icon.constraint { background-color: rgba(255, 218, 185, 0.2); }

    /* Update fragment overlay styles */
    #fragmentOverlay {
        min-width: 300px;
        padding: 12px;
        font-size: 14px;
        line-height: 1.5;
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #fragmentOverlay #fragmentType {
        font-size: 16px;
        margin-bottom: 8px;
        color: #2d3748;
    }

    #fragmentOverlay #fragmentAlignment {
        margin-bottom: 8px;
        color: #4a5568;
    }

    #fragmentOverlay #fragmentSuggestion {
        color: #718096;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-4 flex-grow overflow-hidden flex flex-col w-full">
    <div class="flex flex-grow overflow-hidden w-full">
        <!-- Left Panel -->
        <div class="w-1/3 pr-4 flex flex-col">
            <!-- Model Select -->
            <div class="mb-4">
                <label for="modelSelect" class="block text-sm font-medium text-gray-700">Select Model</label>
                <select id="modelSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                </select>
            </div>

            <!-- Analysis Card -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-4">
                <h3 class="text-lg font-semibold mb-2">Overall Analysis</h3>
                <div class="space-y-2">
                    <p id="goalAlignment" class="text-sm"></p>
                    <p id="effectiveness" class="text-sm"></p>
                    <div class="mt-2">
                        <h4 class="font-medium mb-1">Suggested Improvements</h4>
                        <ul id="improvements" class="text-sm list-disc list-inside"></ul>
                    </div>
                </div>
                <button id="generateTestBtn" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full">
                    Generate Test
                </button>
            </div>

            <button id="analyzeBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full mb-4">
                Analyze Prompt
            </button>
        </div>

        <!-- Right Panel -->
        <div class="w-2/3 pl-4">
            <!-- Main content area - Now full width -->
            <div class="w-full flex flex-col overflow-hidden">
                <!-- Goal textarea -->
                <div class="mb-4">
                    <label for="goal" class="block text-sm font-medium text-gray-700">Goal (optional)</label>
                    <textarea id="goal" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
                </div>

                <!-- Prompt editor with fragment overlay -->
                <div class="mb-4 flex-grow overflow-hidden relative">
                    <label for="prompt" class="block text-sm font-medium text-gray-700">Prompt</label>
                    <textarea id="prompt"></textarea>
                    <div id="fragmentOverlay" class="absolute hidden bg-white border rounded p-2 shadow-lg z-10">
                        <p id="fragmentType" class="font-bold"></p>
                        <p id="fragmentAlignment"></p>
                        <p id="fragmentSuggestion" class="text-sm italic"></p>
                    </div>
                </div>

                <!-- Console -->
                <div id="console" class="bg-black text-white p-2 rounded h-40 overflow-y-auto">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Modal for Tests -->
<div id="testModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-3/4 shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Test Results</h3>
            <button id="closeTestModal" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="testResults"></div>
        <div class="mt-4 flex justify-end">
            <button id="downloadTestsBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Download Tests
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const footer = document.getElementById('footer');
        if (footer) {
            footer.style.display = 'none';
        }
    });

    // All JavaScript from the original file
    $(document).ready(function() {
        let editor = CodeMirror.fromTextArea(document.getElementById("prompt"), {
            lineNumbers: true,
            mode: "markdown",
            theme: "default",
            gutters: ["CodeMirror-linenumbers", "suggestions"]
        });

        let storedTests = [];
        let currentFragments = [];
        let isGoalUserSet = false;
        let lastAnalyzedPrompt = "";
        let lastAnalyzedGoal = "";
        let analysisDebounceTimeout;

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const debouncedAnalysis = debounce(checkAndAnalyzePrompt, 1000);

        editor.on("change", function(cm, changeObj) {
            if (changeObj.origin !== 'setValue') {
                debouncedAnalysis();
            }
        });

        $("#goal").on("input", debounce(function() {
            isGoalUserSet = true;
            checkAndAnalyzePrompt();
        }, 1000));

        function checkAndAnalyzePrompt() {
            let currentPrompt = editor.getValue().trim();
            let currentGoal = $("#goal").val().trim();

            if (currentPrompt !== lastAnalyzedPrompt || (isGoalUserSet && currentGoal !== lastAnalyzedGoal)) {
                if (currentPrompt !== "") {
                    analyzePrompt(currentPrompt, currentGoal);
                    lastAnalyzedPrompt = currentPrompt;
                    lastAnalyzedGoal = currentGoal;
                } else {
                    clearAnalysis();
                }
            }
        }

        function analyzePrompt(prompt, goal) {
            let model = $("#modelSelect").val();

            if (!isGoalUserSet || goal === "") {
                inferGoal(prompt, model);
            } else {
                performAnalysis(prompt, model, goal);
            }
        }

        function inferGoal(prompt, model) {
            $.ajax({
                url: "/api/infer-goal",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    prompt: prompt,
                    model: model
                }),
                success: function(inferred_goal) {
                    $("#goal").val(inferred_goal);
                    lastAnalyzedGoal = inferred_goal;
                    logMessage("info", "Goal inferred: " + inferred_goal);
                    performAnalysis(prompt, model, inferred_goal);
                },
                error: function(xhr, status, error) {
                    console.error("Error inferring goal:", error);
                    logMessage("error", "Failed to infer goal: " + error);
                }
            });
        }

        function performAnalysis(prompt, model, goal) {
            $.ajax({
                url: "/api/analyze-fragments",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    prompt: prompt,
                    model: model,
                    goal: goal
                }),
                success: function(fragments) {
                    currentFragments = fragments;
                    displayFragmentAnalysis(fragments);
                    highlightFragments(fragments);
                    addFragmentTypeIcons(fragments);
                    addInlineSuggestions(fragments);
                },
                error: function(xhr, status, error) {
                    console.error("Error analyzing fragments:", error);
                    logMessage("error", "Failed to analyze fragments: " + error);
                }
            });

            $.ajax({
                url: "/api/analyze-logs",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    prompt: prompt,
                    model: model,
                    goal: goal
                }),
                success: function(logs) {
                    displayLogs(logs);
                },
                error: function(xhr, status, error) {
                    console.error("Error analyzing logs:", error);
                    logMessage("error", "Failed to analyze logs: " + error);
                }
            });

            $.ajax({
                url: "/api/analyze-prompt",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    prompt: prompt,
                    model: model,
                    goal: goal
                }),
                success: function(analysis) {
                    displayAnalysis(analysis);
                },
                error: function(xhr, status, error) {
                    console.error("Error analyzing prompt:", error);
                    logMessage("error", "Failed to analyze prompt: " + error);
                }
            });
        }

        function clearAnalysis() {
            currentFragments = [];
            $("#fragmentList").empty();
            $("#overall").empty();
            editor.operation(() => {
                editor.getAllMarks().forEach(mark => mark.clear());
                editor.clearGutter("suggestions");
            });
            logMessage("info", "Analysis cleared due to empty prompt");
        }

        function highlightFragments(fragments) {
            editor.operation(() => {
                editor.getAllMarks().forEach(mark => mark.clear());
                fragments.forEach(fragment => {
                    let start = editor.posFromIndex(editor.getValue().indexOf(fragment.text));
                    let end = editor.posFromIndex(editor.getValue().indexOf(fragment.text) + fragment.text.length);
                    editor.markText(start, end, {
                        className: `cm-alignment-${fragment.goal_alignment}`
                    });
                });
            });
        }

        function addFragmentTypeIcons(fragments) {
            editor.operation(() => {
                for (let i = 0; i < editor.lineCount(); i++) {
                    editor.removeLineClass(i, "text");
                }
                fragments.forEach(fragment => {
                    let line = editor.posFromIndex(editor.getValue().indexOf(fragment.text)).line;
                    editor.addLineClass(line, "text", `cm-fragment-${fragment.type}`);
                });
            });
        }

        function addInlineSuggestions(fragments) {
            editor.operation(() => {
                editor.clearGutter("suggestions");
                fragments.forEach((fragment, index) => {
                    let line = editor.posFromIndex(editor.getValue().indexOf(fragment.text)).line;
                    editor.setGutterMarker(line, "suggestions", makeMarker(fragment.improvement_suggestion));
                });
            });
        }

        function makeMarker(suggestion) {
            let marker = document.createElement("div");
            marker.innerHTML = "üí°";
            marker.title = suggestion;
            marker.className = "text-yellow-500 cursor-pointer";
            return marker;
        }

        function displayFragmentAnalysis(fragments) {
            editor.operation(() => {
                // Clear existing fragment icons
                $('.fragment-icon').remove();

                fragments.forEach((fragment, index) => {
                    let start = editor.posFromIndex(editor.getValue().indexOf(fragment.text));
                    let coords = editor.charCoords(start, "local");

                    let icon = $(`<div class="fragment-icon ${fragment.type}" title="${fragment.type}">
                        <span>${getFragmentIcon(fragment.type)}</span>
                    </div>`);

                    icon.css('top', coords.top + 'px');

                    // Handle both hover and click events
                    let timeout;

                    icon.on('mouseenter', () => {
                        timeout = setTimeout(() => {
                            showFragmentDetails(fragment, icon);
                        }, 200); // Small delay to prevent unwanted triggers
                    });

                    icon.on('mouseleave', () => {
                        clearTimeout(timeout);
                        // Only hide if it wasn't shown by click
                        if (!icon.data('clicked')) {
                            $('#fragmentOverlay').hide();
                        }
                    });

                    icon.on('click', () => {
                        showFragmentDetails(fragment, icon);
                        icon.data('clicked', true);
                    });

                    $(editor.getWrapperElement()).append(icon);
                });
            });
        }

        function getFragmentIcon(type) {
            const icons = {
                'instruction': 'üìù',
                'context': 'üåç',
                'example': 'üí°',
                'constraint': 'üö´'
            };
            return icons[type] || '‚ùî';
        }

        function showFragmentDetails(fragment, icon) {
            const overlay = $('#fragmentOverlay');
            overlay.find('#fragmentType').text(`${getFragmentIcon(fragment.type)} ${fragment.type.charAt(0).toUpperCase() + fragment.type.slice(1)}`);
            overlay.find('#fragmentAlignment').text(`Goal Alignment: ${fragment.goal_alignment}/5`);
            overlay.find('#fragmentSuggestion').text(`${fragment.improvement_suggestion}`);

            // Position overlay near the icon
            const iconPos = icon.offset();
            const wrapperWidth = $(editor.getWrapperElement()).width();

            overlay.css({
                top: iconPos.top + icon.height() + 5 + 'px',
                left: Math.min(iconPos.left, wrapperWidth - overlay.width() - 20) + 'px',
                display: 'block'
            });

            // Hide overlay when clicking outside
            $(document).one('click', function(e) {
                if (!overlay.is(e.target) && !icon.is(e.target) &&
                    overlay.has(e.target).length === 0 && icon.has(e.target).length === 0) {
                    overlay.hide();
                    icon.data('clicked', false);
                }
            });
        }

        function displayLogs(logs) {
            logs.forEach(function(log) {
                logMessage(log.type, log.message);
            });
        }

        function displayAnalysis(analysis) {
            $("#goalAlignment").text(`Goal Alignment: ${analysis.overall_goal_alignment}/10`);
            $("#effectiveness").text(`Estimated Effectiveness: ${analysis.estimated_effectiveness}/10`);

            let improvementsHtml = analysis.suggested_improvements.map(improvement =>
                `<li>${improvement}</li>`
            ).join('');
            $("#improvements").html(improvementsHtml);

            logMessage("info", "Prompt analyzed successfully");
        }

        function logMessage(type, message) {
            let color = type === "error" ? "text-red-500" : (type === "warning" ? "text-yellow-500" : "text-green-500");
            $("#console").append(`<div class="${color}">[${type.toUpperCase()}] ${message}</div>`);
            $("#console").scrollTop($("#console")[0].scrollHeight);
        }

        $("#analyzeBtn").click(function() {
            checkAndAnalyzePrompt();
        });

        $("#generateTestBtn").click(function() {
            let prompt = editor.getValue();
            let model = $("#modelSelect").val();
            let goal = $("#goal").val();

            $.ajax({
                url: "/api/generate-test",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    prompt: prompt,
                    model: model,
                    goal: goal || undefined
                }),
                success: function(response) {
                    displayTest(response);
                    storedTests.push(response);
                },
                error: function(xhr, status, error) {
                    console.error("Error generating test:", error);
                    logMessage("error", "Failed to generate test: " + error);
                }
            });
            $("#testModal").removeClass("hidden");
        });

        $("#downloadTestsBtn").click(function() {
            if (storedTests.length === 0) {
                logMessage("warning", "No tests to download. Generate some tests first.");
                return;
            }
            let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(storedTests));
            let downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "prompt_tests.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });

        function displayTest(test) {
            let inputHtml = Object.entries(test.input).map(([key, value]) =>
                `<p><strong>${key}:</strong> ${value}</p>`
            ).join('');

            $("#testResults").html(`
                <h3 class="font-bold">Generated Test</h3>
                <div class="mb-2">
                    <h4 class="font-semibold">Input:</h4>
                    ${inputHtml}
                </div>
                <p><strong>Expected Output:</strong> ${test.expected_output}</p>
                <p><strong>Goal Relevance:</strong> ${test.goal_relevance}/5</p>
            `);
            logMessage("info", "Test case generated and stored");
        }

        // Tab switching functionality
        $(".tab-button").click(function() {
            $(".tab-button").removeClass("text-blue-500 border-b-2 border-blue-500").addClass("text-gray-500");
            $(this).removeClass("text-gray-500").addClass("text-blue-500 border-b-2 border-blue-500");
            $(".tab-content").addClass("hidden");
            $("#" + $(this).data("tab")).removeClass("hidden");
        });

        // Resize handler for CodeMirror
        function resizeCodeMirror() {
            let height = window.innerHeight - 400; // Adjust this value as needed
            $(".CodeMirror").css("height", height + "px");
            editor.refresh();
        }

        // Call resizeCodeMirror on window resize
        $(window).resize(resizeCodeMirror);

        // Initialize
        resizeCodeMirror();
        checkAndAnalyzePrompt();

        // Event delegation for fragment highlighting
        $("#fragmentList").on("click", ".mb-4", function() {
            let fragmentIndex = $(this).attr("id").split("-")[1];
            let fragment = currentFragments[fragmentIndex];
            let start = editor.posFromIndex(editor.getValue().indexOf(fragment.text));
            let end = editor.posFromIndex(editor.getValue().indexOf(fragment.text) + fragment.text.length);

            editor.setSelection(start, end);
            editor.scrollIntoView(start, 100);
        });

        // Gutter click handler for fragment highlighting in the panel
        editor.on("gutterClick", function(cm, lineNumber) {
            let fragmentIndex = currentFragments.findIndex(fragment => {
                let start = editor.posFromIndex(editor.getValue().indexOf(fragment.text));
                return start.line === lineNumber;
            });

            if (fragmentIndex !== -1) {
                $(".tab-button[data-tab='fragments']").click(); // Switch to fragments tab
                let fragmentElement = $(`#fragment-${fragmentIndex}`);
                fragmentElement.addClass("bg-yellow-100");
                setTimeout(() => fragmentElement.removeClass("bg-yellow-100"), 2000);
                fragmentElement[0].scrollIntoView({ behavior: "smooth", block: "center" });
            }
        });

        $("#closeTestModal").click(function() {
            $("#testModal").addClass("hidden");
        });

        // Close modal when clicking outside
        $(window).click(function(event) {
            if (event.target.id === "testModal") {
                $("#testModal").addClass("hidden");
            }
        });
    });
</script>
{% endblock %}
