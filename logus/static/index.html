<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Engineering Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .CodeMirror {
            height: 300px;
            border: 1px solid #ddd;
        }
        .cm-relevant-high { background-color: rgba(0, 255, 0, 0.2); }
        .cm-relevant-medium { background-color: rgba(255, 255, 0, 0.2); }
        .cm-relevant-low { background-color: rgba(255, 0, 0, 0.2); }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">Prompt Engineering Tool</h1>
        <div class="flex">
            <div class="w-3/4 pr-4">
                <div class="mb-4">
                    <label for="goal" class="block text-sm font-medium text-gray-700">Goal (optional)</label>
                    <textarea id="goal" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
                </div>
                <div class="mb-4">
                    <label for="prompt" class="block text-sm font-medium text-gray-700">Prompt</label>
                    <textarea id="prompt"></textarea>
                </div>
                <div id="console" class="bg-black text-white p-2 rounded h-40 overflow-y-auto mb-4"></div>
            </div>
            <div class="w-1/4 pl-4">
                <div class="mb-4">
                    <label for="modelSelect" class="block text-sm font-medium text-gray-700">Select Model</label>
                    <select id="modelSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="gpt-4o">GPT-4</option>
                        <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                    </select>
                </div>
                <button id="generateTestBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full mb-4">
                    Generate Test
                </button>
                <button id="analyzeBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full mb-4">
                    Analyze Prompt
                </button>
                <div id="testResults" class="mb-4 p-2 bg-white rounded shadow"></div>
                <button id="downloadTestsBtn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded w-full mb-4">
                    Download Tests
                </button>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let editor = CodeMirror.fromTextArea(document.getElementById("prompt"), {
                lineNumbers: true,
                mode: "markdown",
                theme: "default"
            });

            let storedTests = [];
            let analysisTimeout;

            editor.on("change", function() {
                clearTimeout(analysisTimeout);
                analysisTimeout = setTimeout(analyzePrompt, 1000); // Analyze after 1 second of inactivity
                highlightPrompt();
            });

            function highlightPrompt() {
                editor.eachLine(function(line) {
                    editor.removeLineClass(line, "background");
                });

                let content = editor.getValue();
                let lines = content.split('\n');
                
                lines.forEach(function(line, index) {
                    let relevance = calculateRelevance(line);
                    let className;
                    if (relevance > 0.7) {
                        className = "cm-relevant-high";
                    } else if (relevance > 0.4) {
                        className = "cm-relevant-medium";
                    } else {
                        className = "cm-relevant-low";
                    }
                    editor.addLineClass(index, "background", className);
                });
            }

            function calculateRelevance(line) {
                // This is a placeholder function. In a real implementation,
                // you would use more sophisticated logic or potentially
                // call an API to determine relevance.
                return Math.random(); // Returns a value between 0 and 1
            }

            function analyzePrompt() {
                let prompt = editor.getValue();
                let model = $("#modelSelect").val();
                let goal = $("#goal").val();

                if (!goal) {
                    inferGoal(prompt, model);
                } else {
                    performAnalysis(prompt, model, goal);
                }
            }

            function inferGoal(prompt, model) {
                $.ajax({
                    url: "/api/infer-goal",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        prompt: prompt,
                        model: model
                    }),
                    success: function(inferred_goal) {
                        $("#goal").val(inferred_goal);
                        logMessage("info", "Goal inferred: " + inferred_goal);
                        performAnalysis(prompt, model, inferred_goal);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error inferring goal:", error);
                        logMessage("error", "Failed to infer goal: " + error);
                    }
                });
            }

            function performAnalysis(prompt, model, goal) {
                $.ajax({
                    url: "/api/analyze-prompt",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        prompt: prompt,
                        model: model,
                        goal: goal
                    }),
                    success: function(response) {
                        displayAnalysis(response);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error analyzing prompt:", error);
                        logMessage("error", "Failed to analyze prompt: " + error);
                    }
                });
            }

            $("#analyzeBtn").click(analyzePrompt);

            $("#generateTestBtn").click(function() {
                let prompt = editor.getValue();
                let model = $("#modelSelect").val();
                let goal = $("#goal").val();

                $.ajax({
                    url: "/api/generate-test",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        prompt: prompt,
                        model: model,
                        goal: goal || undefined
                    }),
                    success: function(response) {
                        displayTest(response);
                        storedTests.push(response);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error generating test:", error);
                        logMessage("error", "Failed to generate test: " + error);
                    }
                });
            });

            $("#downloadTestsBtn").click(function() {
                let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(storedTests));
                let downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "prompt_tests.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            });

            function displayAnalysis(analysis) {
                logMessage("info", "Prompt analyzed successfully");
                logMessage("info", "Overall goal alignment: " + analysis.overall_goal_alignment + "/10");
                logMessage("info", "Estimated effectiveness: " + analysis.estimated_effectiveness + "/10");
                analysis.suggested_improvements.forEach(function(improvement, index) {
                    logMessage("info", "Improvement " + (index + 1) + ": " + improvement);
                });
            }

            function displayTest(test) {
                $("#testResults").html(`
                    <h3 class="font-bold">Generated Test</h3>
                    <p><strong>Input:</strong> ${test.input}</p>
                    <p><strong>Expected Output:</strong> ${test.expected_output}</p>
                    <p><strong>Goal Relevance:</strong> ${test.goal_relevance}/5</p>
                `);
                logMessage("info", "Test case generated and stored");
            }

            function logMessage(type, message) {
                let color = type === "error" ? "text-red-500" : (type === "warning" ? "text-yellow-500" : "text-green-500");
                $("#console").append(`<div class="${color}">[${type.toUpperCase()}] ${message}</div>`);
                $("#console").scrollTop($("#console")[0].scrollHeight);
            }
        });
    </script>
</body>
</html>