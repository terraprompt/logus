<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logus: Prompt Engineering Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .CodeMirror {
            height: 300px;
            border: 1px solid #ddd;
        }
        .cm-alignment-1 { background-color: rgba(255, 0, 0, 0.2); }
        .cm-alignment-2 { background-color: rgba(255, 165, 0, 0.2); }
        .cm-alignment-3 { background-color: rgba(255, 255, 0, 0.2); }
        .cm-alignment-4 { background-color: rgba(144, 238, 144, 0.2); }
        .cm-alignment-5 { background-color: rgba(0, 255, 0, 0.2); }
        .cm-fragment-instruction::before { content: "üìù"; }
        .cm-fragment-context::before { content: "üåç"; }
        .cm-fragment-example::before { content: "üí°"; }
        .cm-fragment-constraint::before { content: "üö´"; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">Logus: Prompt Engineering Tool</h1>
        <div class="flex">
            <div class="w-3/4 pr-4">
                <div class="mb-4">
                    <label for="goal" class="block text-sm font-medium text-gray-700">Goal (optional)</label>
                    <textarea id="goal" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
                </div>
                <div class="mb-4 relative">
                    <label for="prompt" class="block text-sm font-medium text-gray-700">Prompt</label>
                    <textarea id="prompt"></textarea>
                    <div id="fragmentOverlay" class="absolute hidden bg-white border rounded p-2 shadow-lg z-10">
                        <p id="fragmentType" class="font-bold"></p>
                        <p id="fragmentAlignment"></p>
                        <p id="fragmentSuggestion" class="text-sm italic"></p>
                    </div>
                </div>
                <div id="console" class="bg-black text-white p-2 rounded h-40 overflow-y-auto mb-4"></div>
            </div>
            <div class="w-1/4 pl-4">
                <div class="mb-4">
                    <label for="modelSelect" class="block text-sm font-medium text-gray-700">Select Model</label>
                    <select id="modelSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="gpt-4o">GPT-4o</option>
                        <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                    </select>
                </div>
                <div id="overallAnalysis" class="mb-4 p-4 bg-white rounded shadow">
                    <h3 class="font-bold mb-2">Overall Analysis</h3>
                    <p id="goalAlignment"></p>
                    <p id="effectiveness"></p>
                    <h4 class="font-semibold mt-2">Suggested Improvements:</h4>
                    <ul id="improvements" class="list-disc pl-5"></ul>
                </div>
                <button id="generateTestBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full mb-4">
                    Generate Test
                </button>
                <button id="analyzeBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full mb-4">
                    Analyze Prompt
                </button>
                <div id="testResults" class="mb-4 p-2 bg-white rounded shadow"></div>
                <button id="downloadTestsBtn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded w-full mb-4">
                    Download Tests
                </button>
            </div>
        </div>
    </div>

    <div id="fragmentPanel" class="fixed right-0 top-0 h-full w-64 bg-white shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out">
        <button id="togglePanel" class="absolute left-0 top-1/2 -translate-x-full bg-blue-500 text-white p-2 rounded-l">
            Fragment Analysis
        </button>
        <div id="fragmentList" class="p-4 overflow-y-auto h-full"></div>
    </div>

    <script>
        $(document).ready(function() {
            let editor = CodeMirror.fromTextArea(document.getElementById("prompt"), {
                lineNumbers: true,
                mode: "markdown",
                theme: "default",
                gutters: ["CodeMirror-linenumbers", "suggestions"]
            });

            let storedTests = [];
            let analysisTimeout;
            let currentFragments = [];

            editor.on("change", function() {
                clearTimeout(analysisTimeout);
                analysisTimeout = setTimeout(analyzePrompt, 1000); // Analyze after 1 second of inactivity
            });

            editor.on("mouseover", function(cm, event) {
                let pos = cm.coordsChar({left: event.clientX, top: event.clientY});
                let fragmentInfo = getFragmentAtPosition(pos);
                if (fragmentInfo) {
                    showFragmentOverlay(fragmentInfo, event.clientX, event.clientY);
                } else {
                    hideFragmentOverlay();
                }
            });

            function getFragmentAtPosition(pos) {
                return currentFragments.find(fragment => {
                    let start = editor.posFromIndex(editor.getValue().indexOf(fragment.text));
                    let end = editor.posFromIndex(editor.getValue().indexOf(fragment.text) + fragment.text.length);
                    return pos.line >= start.line && pos.line <= end.line;
                });
            }

            function showFragmentOverlay(fragmentInfo, x, y) {
                $("#fragmentType").text("Type: " + fragmentInfo.type);
                $("#fragmentAlignment").text("Alignment: " + fragmentInfo.goal_alignment + "/5");
                $("#fragmentSuggestion").text("Suggestion: " + fragmentInfo.improvement_suggestion);
                $("#fragmentOverlay").css({top: y + 10, left: x + 10}).removeClass("hidden");
            }

            function hideFragmentOverlay() {
                $("#fragmentOverlay").addClass("hidden");
            }

            function analyzePrompt() {
                let prompt = editor.getValue();
                let model = $("#modelSelect").val();
                let goal = $("#goal").val();

                if (!goal) {
                    inferGoal(prompt, model);
                } else {
                    performAnalysis(prompt, model, goal);
                }
            }

            function inferGoal(prompt, model) {
                $.ajax({
                    url: "/api/infer-goal",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        prompt: prompt,
                        model: model
                    }),
                    success: function(inferred_goal) {
                        $("#goal").val(inferred_goal);
                        logMessage("info", "Goal inferred: " + inferred_goal);
                        performAnalysis(prompt, model, inferred_goal);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error inferring goal:", error);
                        logMessage("error", "Failed to infer goal: " + error);
                    }
                });
            }

            function performAnalysis(prompt, model, goal) {
                $.ajax({
                    url: "/api/analyze-fragments",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        prompt: prompt,
                        model: model,
                        goal: goal
                    }),
                    success: function(fragments) {
                        currentFragments = fragments;
                        displayFragmentAnalysis(fragments);
                        highlightFragments(fragments);
                        addFragmentTypeIcons(fragments);
                        addInlineSuggestions(fragments);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error analyzing fragments:", error);
                        logMessage("error", "Failed to analyze fragments: " + error);
                    }
                });

                $.ajax({
                    url: "/api/analyze-logs",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        prompt: prompt,
                        model: model,
                        goal: goal
                    }),
                    success: function(logs) {
                        displayLogs(logs);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error analyzing logs:", error);
                        logMessage("error", "Failed to analyze logs: " + error);
                    }
                });

                $.ajax({
                    url: "/api/analyze-prompt",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        prompt: prompt,
                        model: model,
                        goal: goal
                    }),
                    success: function(analysis) {
                        displayAnalysis(analysis);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error analyzing prompt:", error);
                        logMessage("error", "Failed to analyze prompt: " + error);
                    }
                });
            }

            function highlightFragments(fragments) {
                editor.operation(() => {
                    editor.getAllMarks().forEach(mark => mark.clear());
                    fragments.forEach(fragment => {
                        let start = editor.posFromIndex(editor.getValue().indexOf(fragment.text));
                        let end = editor.posFromIndex(editor.getValue().indexOf(fragment.text) + fragment.text.length);
                        editor.markText(start, end, {
                            className: `cm-alignment-${fragment.goal_alignment}`
                        });
                    });
                });
            }

            function addFragmentTypeIcons(fragments) {
                editor.operation(() => {
                    for (let i = 0; i < editor.lineCount(); i++) {
                        editor.removeLineClass(i, "text");
                    }
                    fragments.forEach(fragment => {
                        let line = editor.posFromIndex(editor.getValue().indexOf(fragment.text)).line;
                        editor.addLineClass(line, "text", `cm-fragment-${fragment.type}`);
                    });
                });
            }

            function addInlineSuggestions(fragments) {
                editor.operation(() => {
                    editor.clearGutter("suggestions");
                    fragments.forEach((fragment, index) => {
                        let line = editor.posFromIndex(editor.getValue().indexOf(fragment.text)).line;
                        editor.setGutterMarker(line, "suggestions", makeMarker(fragment.improvement_suggestion));
                    });
                });
            }

            function makeMarker(suggestion) {
                let marker = document.createElement("div");
                marker.innerHTML = "üí°";
                marker.title = suggestion;
                marker.className = "text-yellow-500 cursor-pointer";
                return marker;
            }

            $("#analyzeBtn").click(analyzePrompt);

            $("#generateTestBtn").click(function() {
                let prompt = editor.getValue();
                let model = $("#modelSelect").val();
                let goal = $("#goal").val();

                $.ajax({
                    url: "/api/generate-test",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        prompt: prompt,
                        model: model,
                        goal: goal || undefined
                    }),
                    success: function(response) {
                        displayTest(response);
                        storedTests.push(response);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error generating test:", error);
                        logMessage("error", "Failed to generate test: " + error);
                    }
                });
            });

            $("#downloadTestsBtn").click(function() {
                let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(storedTests));
                let downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "prompt_tests.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            });

            function displayFragmentAnalysis(fragments) {
                let html = fragments.map((fragment, index) => `
                    <div class="mb-4 p-2 border rounded">
                        <h4 class="font-bold">Fragment ${index + 1}</h4>
                        <p>${fragment.text}</p>
                        <p>Type: ${fragment.type}</p>
                        <p>Alignment: ${fragment.goal_alignment}/5</p>
                        <p class="text-sm italic">Suggestion: ${fragment.improvement_suggestion}</p>
                    </div>
                `).join('');
                $("#fragmentList").html(html);
            }

            function displayLogs(logs) {
                logs.forEach(function(log) {
                    logMessage(log.type, log.message);
                });
            }

            function displayAnalysis(analysis) {
                $("#goalAlignment").text(`Goal Alignment: ${analysis.overall_goal_alignment}/10`);
                $("#effectiveness").text(`Estimated Effectiveness: ${analysis.estimated_effectiveness}/10`);
                
                let improvementsHtml = analysis.suggested_improvements.map(improvement => 
                    `<li>${improvement}</li>`
                ).join('');
                $("#improvements").html(improvementsHtml);

                logMessage("info", "Prompt analyzed successfully");
            }

            function displayTest(test) {
                let inputHtml = Object.entries(test.input).map(([key, value]) => 
                    `<p><strong>${key}:</strong> ${value}</p>`
                ).join('');
                
                $("#testResults").html(`
                    <h3 class="font-bold">Generated Test</h3>
                    <div class="mb-2">
                        <h4 class="font-semibold">Input:</h4>
                        ${inputHtml}
                    </div>
                    <p><strong>Expected Output:</strong> ${test.expected_output}</p>
                    <p><strong>Goal Relevance:</strong> ${test.goal_relevance}/5</p>
                `);
                logMessage("info", "Test case generated and stored");
            }

            function logMessage(type, message) {
                let color = type === "error" ? "text-red-500" : (type === "warning" ? "text-yellow-500" : "text-green-500");
                $("#console").append(`<div class="${color}">[${type.toUpperCase()}] ${message}</div>`);
                $("#console").scrollTop($("#console")[0].scrollHeight);
            }

            // Toggle fragment analysis panel
            $("#togglePanel").click(function() {
                $("#fragmentPanel").toggleClass("translate-x-0");
            });

            // Close fragment overlay when clicking outside
            $(document).on("click", function(event) {
                if (!$(event.target).closest("#fragmentOverlay").length) {
                    hideFragmentOverlay();
                }
            });

            // Initialize
            analyzePrompt();
        });
    </script>
</body>
</html>